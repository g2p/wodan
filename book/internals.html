<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Code organisation - Wodan book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Design</li><li class="chapter-item expanded "><a href="scope.html"><strong aria-hidden="true">1.</strong> Scope</a></li><li class="chapter-item expanded "><a href="semantics.html"><strong aria-hidden="true">2.</strong> Semantics</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">3.</strong> Design choices</a></li><li class="chapter-item expanded affix "><li class="part-title">Internals</li><li class="chapter-item expanded "><a href="layout.html"><strong aria-hidden="true">4.</strong> On-disk layout</a></li><li class="chapter-item expanded "><a href="internals.html" class="active"><strong aria-hidden="true">5.</strong> Code organisation</a></li><li class="chapter-item expanded "><a href="free-space.html"><strong aria-hidden="true">6.</strong> Free space and ENOSPC</a></li><li class="chapter-item expanded affix "><li class="part-title">Proposed features</li><li class="chapter-item expanded "><a href="proposed/linear-layout.html"><strong aria-hidden="true">7.</strong> Linear, growable layout</a></li><li class="chapter-item expanded "><a href="proposed/git.html"><strong aria-hidden="true">8.</strong> Git on top of Wodan</a></li><li class="chapter-item expanded affix "><li class="part-title">Further reading</li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">9.</strong> References</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Wodan book</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#wodan-internals" id="wodan-internals">Wodan internals</a></h1>
<h2><a class="header" href="#packages" id="packages">Packages</a></h2>
<h3><a class="header" href="#wodan" id="wodan">wodan</a></h3>
<p>The wodan package is at the bottom of the package hierarchy
and implements the file-system, provided an abstract module
that does IO.</p>
<h4><a class="header" href="#implementation-notes" id="implementation-notes">Implementation notes</a></h4>
<p>There are data structures and utility methods defined at the top level.</p>
<p>There are cstructs defined for the layout of different types of blocks:
superblock, root node or child node. Additionally, an anynode cstruct contains
the fields common to root and child nodes.</p>
<p>The main data structures are a cache, containing a LRU, and LRU entries.</p>
<p>LRU entries are the in-memory representation of nodes.  Nodes contain and index
children and inline data.  The childlink can contain an alloc id if the child
has been loaded, which allows navigating the live tree.</p>
<p>The cache structure contains the LRU, a subtree for dirty nodes, various counters
which are used to allocate sequential numbers, counters used to track free
space, a map of where free space is on the filesystem, other counters used to
track statistics.</p>
<p>The main user-facing module is a Make functor, which takes a block device and a
set of parameters that control data layout.</p>
<p>The API contains the verbs:</p>
<ul>
<li>
<p>prepare_io for opening a device. Takes flags for either formatting an empty
device, or opening an existing filesystem. This returns a set of filesystem
roots indexed by their root id. Roots are references to a filesystem root.</p>
</li>
<li>
<p>insert for inserting data into a root. Currently deleting is done by
inserting a zero-sized value.</p>
</li>
<li>
<p>lookup for reading the value associated with a key within a root.</p>
</li>
<li>
<p>flush for landing pending data on the disk.</p>
</li>
</ul>
<p>Opening the filesystem involves locating the root block (using a bisection that
looks for the highest generation number of a root), checking the filesystem,
and scanning the entirety of if to establish a free space map. This will be
improved by maintaining a space map as part of a secondary metadata root.</p>
<p>The implementation for insert is split into a half that reserves space, might
rebalance the tree, might load nodes from disk, and a fast half that
immediately inserts into already available space. The reserve implementation is
sometimes called to reserve space for a batch of fast inserts; this is the case
when a node spills into a lower node. This split allows better error reporting
when there is no free space.</p>
<h3><a class="header" href="#wodan-unix" id="wodan-unix">wodan-unix</a></h3>
<p>The wodan-unix package depends on Wodan and Unix,
so that the filesystem can be backed by standard files.</p>
<p>It contains a wodanc command, which is a multitool
that can create filesystems, dump and restore data
from/into filesystems, and trim unused blocks.</p>
<p>It can also run benchmarks, run other tests that
attempt to exercise most of the code base, and
fuzz the same tests.</p>
<h3><a class="header" href="#wodan-irmin" id="wodan-irmin">wodan-irmin</a></h3>
<p>The wodan-irmin package provides some Irmin database types
that can be constructed from Wodan filesystems.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="layout.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="free-space.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="layout.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="free-space.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
